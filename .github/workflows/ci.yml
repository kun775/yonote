name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

jobs:
  lint:
    name: 代码检查
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install ruff bandit safety

      - name: Ruff 代码检查
        run: ruff check . --output-format=github

      - name: Ruff 格式检查
        run: ruff format --check .

  security:
    name: 安全扫描
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety
          pip install -r requirements.txt

      - name: Bandit 安全扫描
        run: bandit -r . -x ./tests,./.venv -ll
        continue-on-error: true

      - name: Safety 依赖检查
        run: safety check -r requirements.txt --output text
        continue-on-error: true

  test:
    name: 测试
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-flask pytest-cov

      - name: 创建数据目录
        run: mkdir -p data

      - name: 运行测试
        run: |
          if [ -d "tests" ] && [ "$(ls -A tests/*.py 2>/dev/null)" ]; then
            pytest tests/ -v --cov=. --cov-report=xml
          else
            echo "⚠️ 未找到测试文件，跳过测试"
            echo "建议添加 pytest 测试到 tests/ 目录"
          fi
        env:
          SECRET_KEY: test_secret_key
          ENCRYPTION_KEY: test_encryption_key
          ENCRYPTION_SALT: test_salt

      - name: 验证应用可启动
        run: |
          timeout 5 python -c "
          import sys
          sys.path.insert(0, '.')
          from app import app
          print('✅ Flask 应用加载成功')
          " || true
        env:
          SECRET_KEY: test_secret_key
          ENCRYPTION_KEY: test_encryption_key
          ENCRYPTION_SALT: test_salt
